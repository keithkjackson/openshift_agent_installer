apiVersion: v1alpha1
kind: AgentConfig
metadata:
  name: {{ cluster_name }}
rendezvousIP: {{ agent_hosts[0].interfaces[0].ip_address }}
{% if agent_hosts | length > 0 %}
hosts:
{% for host in agent_hosts %}
  - hostname: {{ host.hostname }}
    role: {{ host.role }}
{% if host.rootDeviceHints is defined %}
    rootDeviceHints:
{% for key, value in host.rootDeviceHints.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
    interfaces:
{% for interface in host.interfaces %}
      - name: {{ interface.name }}
        macAddress: {{ interface.macAddress }}
{% endfor %}
{% if host.networkConfig is defined %}
    networkConfig:
{% if host.networkConfig.interfaces is defined %}
      interfaces:
{% for interface in host.networkConfig.interfaces %}
        - name: {{ interface.name }}
          type: {{ interface.type }}
          state: {{ interface.state }}
{% if interface.mtu is defined %}
          mtu: {{ interface.mtu }}
{% endif %}
{% if interface.ipv4 is defined %}
          ipv4:
            enabled: {{ interface.ipv4.enabled | lower }}
{% if interface.ipv4.dhcp is defined %}
            dhcp: {{ interface.ipv4.dhcp | lower }}
{% endif %}
{% if interface.ipv4.address is defined %}
            address:
{% for addr in interface.ipv4.address %}
              - ip: {{ addr.ip }}
                prefix-length: {{ addr['prefix-length'] }}
{% endfor %}
{% endif %}
{% endif %}
{% if interface.ipv6 is defined %}
          ipv6:
            enabled: {{ interface.ipv6.enabled | lower }}
{% if interface.ipv6.dhcp is defined %}
            dhcp: {{ interface.ipv6.dhcp | lower }}
{% endif %}
{% if interface.ipv6.address is defined %}
            address:
{% for addr in interface.ipv6.address %}
              - ip: {{ addr.ip }}
                prefix-length: {{ addr['prefix-length'] }}
{% endfor %}
{% endif %}
{% endif %}
{% if interface.linkAggregation is defined %}
          linkAggregation:
            mode: {{ interface.linkAggregation.mode }}
{% if interface.linkAggregation.options is defined %}
            options:
{% for key, value in interface.linkAggregation.options.items() %}
              {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% if interface.linkAggregation.port is defined %}
            port:
{% for port in interface.linkAggregation.port %}
              - {{ port }}
{% endfor %}
{% endif %}
{% endif %}
{% if interface.vlan is defined %}
          vlan:
{% for key, value in interface.vlan.items() %}
            {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
{% if host.networkConfig['dns-resolver'] is defined %}
      dns-resolver:
        config:
          server:
{% for server in host.networkConfig['dns-resolver'].config.server %}
            - {{ server }}
{% endfor %}
{% endif %}
{% if host.networkConfig.routes is defined %}
      routes:
        config:
{% for route in host.networkConfig.routes.config %}
          - destination: {{ route.destination }}
            next-hop-address: {{ route['next-hop-address'] }}
            next-hop-interface: {{ route['next-hop-interface'] }}
{% if route.metric is defined %}
            metric: {{ route.metric }}
{% endif %}
{% if route.table is defined %}
            table: {{ route.table }}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
